name: Run unit tests

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches:
    - main
    - docker_branch
  pull_request:
    branches: [ main ]

jobs:
  
  test:
    name: Test
    runs-on: ubuntu-latest

  steps:
  - name: Checkout
    uses: actions/checkout@v3

  - name: Setup Terraform
    uses: hashicorp/setup-terraform@v1

  - name: Terraform Validate
    uses: dflook/terraform-validate@v1


  - name: Set up Go
    uses: actions/setup-go@v2
    with:
      go-version: ^1.18
    id: go


  - name: Install golang-migrate
    run: |
      curl -L https://github.com/golang-migrate/migrate/releases/download/v4.14.1/migrate.linux-amd64.tar.gz | tar xvz
      sudo mv migrate.linux-amd64 /usr/bin/migrate
      which migrate
  - name: Run migrations
    run: make migrateup

  - name: Validate failed
    if: ${{ failure() && steps.validate.outputs.failure-reason == 'validate-failed' }}
    run: echo "terraform validate failed"

  - name: Test
    run: make test